name: Smoke Test

on:
  workflow_call:
    inputs:
      package:
        description: 'Package name to test'
        required: true
        type: string
      version:
        description: 'Package version to test'
        required: true
        type: string
      export:
        description: 'Main export to test'
        required: true
        type: string
      timeout:
        description: 'Timeout in minutes'
        required: false
        type: number
        default: 10
  workflow_dispatch:
    inputs:
      package:
        description: 'Package name to test'
        required: true
        type: string
        default: 'heb-sdk-unofficial'
      version:
        description: 'Package version to test'
        required: true
        type: string
      export:
        description: 'Main export to test'
        required: true
        type: string
        default: 'HEBClient'
      timeout:
        description: 'Timeout in minutes'
        required: false
        type: number
        default: 10

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout }}
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Wait for package availability
        run: |
          PACKAGE="${{ inputs.package }}"
          VERSION="${{ inputs.version }}"
          echo "Waiting for $PACKAGE@$VERSION to be available on npm..."
          for i in {1..30}; do
            if npm view "$PACKAGE@$VERSION" version &>/dev/null; then
              echo "Package $PACKAGE@$VERSION is available!"
              exit 0
            fi
            echo "Attempt $i: Package not yet available, waiting 10s..."
            sleep 10
          done
          echo "Timeout waiting for package"
          exit 1

      - name: Create test project
        run: |
          mkdir -p /tmp/smoke-test
          cd /tmp/smoke-test
          npm init -y
          npm install "${{ inputs.package }}@${{ inputs.version }}"

      - name: Test import
        working-directory: /tmp/smoke-test
        run: |
          cat > test.mjs << 'EOF'
          import { ${{ inputs.export }} } from '${{ inputs.package }}';
          
          // Test that the package can be imported and instantiated
          const instance = new ${{ inputs.export }}();
          console.log('${{ inputs.export }} imported and instantiated successfully');
          console.log('Available methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(instance)).filter(m => m !== 'constructor'));
          EOF
          node test.mjs

      - name: Test TypeScript types
        working-directory: /tmp/smoke-test
        run: |
          npm install typescript @types/node --save-dev
          cat > test.ts << 'EOF'
          import { ${{ inputs.export }} } from '${{ inputs.package }}';
          
          const instance: ${{ inputs.export }} = new ${{ inputs.export }}();
          console.log('TypeScript types check passed');
          EOF
          npx tsc --init --strict --esModuleInterop --module NodeNext --moduleResolution NodeNext --target ES2022
          npx tsc --noEmit test.ts
